// TODO:为所有构造函数这只默认值
// 初始化canvas
var canvas=document.getElementById("canvas");var context=canvas.getContext('2d');var elements=[];var bullets=[];window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimaitionFrame||window.msRequestAnimationFrame||function(callback){setTimeout(callback,1000/60)};var key_pressed={};var enemies=[];var enemyOpts={x:3*enemySize,y:enemySize};var score=0;function Plane(){var image=new Image();image.src=planeIcon;this.img=image;this.width=planeSizeWidth;this.height=planeSizeHeight;this.x=350-(this.width/2);this.y=600-this.height-canvasPadding}Plane.prototype.draw=function(){context.drawImage(this.img,this.x,this.y,this.width,this.height)};Plane.prototype.fly=function(k){if(k===37){if(this.x<=canvasPadding){return}this.x-=planeSpeed;refresh()}else if(k===39){if(this.x>=610){return}this.x+=planeSpeed;refresh()}};var plane=new Plane({});elements.push(plane);function Bullet(){this.x=plane.x+(plane.width/2);this.y=plane.y}Bullet.prototype.draw=function(){context.beginPath();context.moveTo(this.x,this.y);context.lineTo(this.x,this.y+bulletSize);context.closePath();context.strokeStyle="#fff";context.save();context.stroke()};Bullet.prototype.move=function(){this.y-=bulletSpeed};function keyEvent(){document.addEventListener("keyup",function(e){var keyCode=e.keyCode||e.which||e.charCode;key_pressed[keyCode]=false});document.addEventListener("keydown",function(e){var keyCode=e.keyCode||e.which||e.charCode;key_pressed[keyCode]=true});setInterval(function(){for(var k in key_pressed){if(key_pressed[k]){if(k==='37'||k==='39'){plane.fly(parseInt(k))}}}},50);setInterval(function(){for(var k in key_pressed){if(key_pressed[k]){if(k==='32'){var bullet=new Bullet();bullets.push(bullet);refresh();animate(bullet)}}}},320)}function animate(bullet){if(bullet.y<= -bulletSize){if(bullets.indexOf(bullet)===-1){return}else{bullets.splice(bullets.indexOf(bullet),1)}bullet=null;return}bullet.move();refresh();requestAnimationFrame(function(){animate(bullet)})}function Enemy(options){var image=new Image();image.src=enemyIcon;this.img=image;this.x=options.x||3*enemySize;this.y=options.y||canvasPadding;this.width=enemySize;this.height=enemySize;this.direction=enemyDirection}Enemy.prototype.draw=function(){context.drawImage(this.img,this.x,this.y,this.width,this.height)};Enemy.prototype.move=function(){if(this.direction==='right'){this.x+=enemySpeed}else{this.x-=enemySpeed}};Enemy.prototype.died=function(){var img=new Image();img.src=enemyBoomIcon;this.img=img};function createEnm(level){for(var l=0;l<level;l+=1){for(var i=0;i<numPerLine;i+=1){var enemy=new Enemy(enemyOpts);enemies.push(enemy);enemyOpts.x+=enemySize}enemyOpts.x=3*enemySize;enemyOpts.y+=enemySize}enemyOpts={x:3*enemySize,y:canvasPadding}}function collision(){setInterval(function(){bullets.forEach(function(bulletItem){enemies.forEach(function(enemyItem){var validRangeObj=validRange(enemyItem);if(bulletItem.x+1<validRangeObj.minx||bulletItem.y+bulletSize<validRangeObj.miny||validRangeObj.maxx<bulletItem.x||validRangeObj.maxy<bulletItem.y){}else{score+=1;bullets.splice(bullets.indexOf(bulletItem),1);enemyItem.died();refresh();setTimeout(function(){enemies.splice(enemies.indexOf(enemyItem),1);refresh()},100)}})})},50)}collision();function validRange(enemies){var obj={};obj.validWidth=enemies.width-20;obj.validHeight=enemies.height-20;obj.minx=enemies.x+10;obj.miny=enemies.y+10;obj.maxx=obj.minx+obj.validWidth;obj.maxy=obj.miny+obj.validHeight;return obj}function drawText(){context.font='18px 微软雅黑';context.fillStyle="#fff";context.save();context.fillText('分数：'+score,20,20)}function enemyAnt(){if(enemies.length===0){if(level===totalLevel){GAME.allSuccess();return}else{GAME.success();level+=1;return}}for(var i=0,len=enemies.length;i<len;i+=1){if(enemies[i].y>=470){enemies=[];GAME.failed();return}}var enemiesWidth=enemies[0].width;var maxx=700-canvasPadding-enemiesWidth;for(var i=0,len=enemies.length;i<len;i+=1){if(enemies[i].x<=canvasPadding){enemies.forEach(function(enemyItem){enemyItem.direction='right';enemyItem.y+=enemyItem.width});break}else if(enemies[i].x>=maxx){enemies.forEach(function(enemyItem){enemyItem.direction='left';enemyItem.y+=enemyItem.width});break}}enemies.forEach(function(enemyItem){enemyItem.move()});refresh();requestAnimationFrame(enemyAnt)}function clear(){context.clearRect(0,0,canvas.width,canvas.height)}function draw(){elements.forEach(function(elements){elements.draw()});bullets.forEach(function(bullets){bullets.draw()});enemies.forEach(function(enenmies){enenmies.draw()});drawText()}function refresh(){clear();draw()}if(elements.length){keyEvent()}